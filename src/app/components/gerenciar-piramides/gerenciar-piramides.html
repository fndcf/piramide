<!-- src/app/components/gerenciar-piramides/gerenciar-piramides.html -->

<div class="modal-overlay" *ngIf="mostrar" (click)="fecharModal()">
  <div class="modal-content gerenciar-piramides" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>ğŸ—ï¸ Gerenciar PirÃ¢mides</h3>
      <button class="btn-close" (click)="fecharModal()">Ã—</button>
    </div>
    
    <div class="modal-body">
      <!-- Filtros e Controles -->
      <div class="controles-superiores">
        <div class="filtros">
          <div class="filtro-grupo">
            <label>Status:</label>
            <select [(ngModel)]="filtroStatus" class="filtro-select">
              <option value="todas">Todas</option>
              <option value="ativa">Ativas</option>
              <option value="pausada">Pausadas</option>
              <option value="finalizada">Finalizadas</option>
              <option value="arquivada">Arquivadas</option>
            </select>
          </div>
          
          <div class="filtro-grupo">
            <label>Categoria:</label>
            <select [(ngModel)]="filtroCategoria" class="filtro-select">
              <option value="todas">Todas</option>
              <option *ngFor="let cat of categorias" [value]="cat.value">{{ cat.label }}</option>
            </select>
          </div>
          
          <div class="filtro-grupo busca">
            <label>Buscar:</label>
            <input type="text" 
                   [(ngModel)]="termoBusca" 
                   placeholder="Nome da pirÃ¢mide..."
                   class="filtro-input">
          </div>
        </div>
        
        <div class="acoes-principais">
          <button class="btn-nova-piramide" (click)="abrirModalNova()">
            â• Nova PirÃ¢mide
          </button>
        </div>
      </div>

      <!-- Lista de PirÃ¢mides -->
      <div class="piramides-lista" *ngIf="!loading">
        <div class="piramide-card" 
             *ngFor="let piramide of piramidesFiltradas"
             [class.atual]="isAtual(piramide)"
             [style.border-left-color]="piramide.cor">
          
          <div class="piramide-header">
            <div class="piramide-info">
              <span class="piramide-icone">{{ piramide.icone }}</span>
              <div class="piramide-detalhes">
                <h4 class="piramide-nome">{{ piramide.nome }}</h4>
                <div class="piramide-meta">
                  <span class="categoria">{{ getCategoriaNome(piramide.categoria) }}</span>
                  <span class="separador">â€¢</span>
                  <span class="duplas-count">{{ piramide.totalDuplas }} duplas</span>
                  <span class="separador">â€¢</span>
                  <span class="ultima-atividade">{{ formatarData(piramide.ultimaAtividade) }}</span>
                </div>
              </div>
            </div>
            
            <div class="piramide-status">
              <span class="status-badge" [class]="getStatusBadgeClass(piramide.status)">
                {{ piramide.status }}
              </span>
              <span class="atual-badge" *ngIf="isAtual(piramide)">ATUAL</span>
            </div>
          </div>
          
          <div class="piramide-acoes">
            <button class="btn-acao selecionar" 
                    (click)="selecionarPiramide(piramide)"
                    [disabled]="isAtual(piramide) || piramide.status === 'arquivada'"
                    title="Selecionar como pirÃ¢mide ativa">
              ğŸ¯ {{ isAtual(piramide) ? 'Selecionada' : 'Selecionar' }}
            </button>
            
            <button class="btn-acao estatisticas" 
                    (click)="abrirEstatisticas(piramide)"
                    title="Ver estatÃ­sticas">
              ğŸ“Š
            </button>
            
            <button class="btn-acao editar" 
                    (click)="abrirModalEdicao(piramide)"
                    title="Editar pirÃ¢mide">
              âœï¸
            </button>
            
            <div class="dropdown-acoes">
              <button class="btn-acao mais" title="Mais aÃ§Ãµes">â‹®</button>
              <div class="dropdown-menu">
                <button *ngIf="piramide.status === 'ativa'" 
                        (click)="alterarStatus(piramide, 'pausada')">
                  â¸ï¸ Pausar
                </button>
                <button *ngIf="piramide.status === 'pausada'" 
                        (click)="alterarStatus(piramide, 'ativa')">
                  â–¶ï¸ Reativar
                </button>
                <button *ngIf="piramide.status !== 'finalizada'" 
                        (click)="alterarStatus(piramide, 'finalizada')">
                  ğŸ Finalizar
                </button>
                <button *ngIf="piramide.status !== 'arquivada'" 
                        (click)="arquivarPiramide(piramide)"
                        class="acao-perigosa">
                  ğŸ“¦ Arquivar
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Mensagem quando nÃ£o hÃ¡ pirÃ¢mides -->
        <div class="sem-piramides" *ngIf="piramidesFiltradas.length === 0">
          <div class="icone">ğŸ—ï¸</div>
          <h4>Nenhuma pirÃ¢mide encontrada</h4>
          <p>Crie sua primeira pirÃ¢mide ou ajuste os filtros</p>
          <button class="btn-criar-primeira" (click)="abrirModalNova()">
            â• Criar Primeira PirÃ¢mide
          </button>
        </div>
      </div>

      <!-- Loading -->
      <div class="loading-container" *ngIf="loading">
        <div class="spinner"></div>
        <p>Carregando pirÃ¢mides...</p>
      </div>

      <!-- Mensagem de feedback -->
      <div class="alert-message" *ngIf="mensagem" [class]="tipoMensagem">
        {{ mensagem }}
      </div>
    </div>
  </div>
</div>

<!-- Modal Nova PirÃ¢mide -->
<div class="modal-overlay" *ngIf="mostrarModalNova" (click)="fecharModalNova()">
  <div class="modal-content nova-piramide" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>â• Nova PirÃ¢mide</h3>
      <button class="btn-close" (click)="fecharModalNova()">Ã—</button>
    </div>
    
    <div class="modal-body">
      <form (ngSubmit)="criarPiramide()" #novaForm="ngForm">
        <div class="form-group">
          <label>Nome da PirÃ¢mide *</label>
          <input type="text" 
                 [(ngModel)]="novaPiramide.nome" 
                 name="nome"
                 placeholder="Ex: PirÃ¢mide Masculina 2025"
                 required
                 class="form-control">
        </div>
        
        <div class="form-group">
          <label>DescriÃ§Ã£o</label>
          <textarea [(ngModel)]="novaPiramide.descricao" 
                    name="descricao"
                    placeholder="DescriÃ§Ã£o opcional da pirÃ¢mide..."
                    class="form-control" 
                    rows="3"></textarea>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Categoria *</label>
            <select [(ngModel)]="novaPiramide.categoria" 
                    name="categoria"
                    required
                    class="form-control">
              <option *ngFor="let cat of categorias" [value]="cat.value">
                {{ cat.label }}
              </option>
            </select>
            <small class="help-text">
              {{ getCategoriaDescricao(novaPiramide.categoria) }}
            </small>
          </div>
          
          <div class="form-group">
            <label>MÃ¡ximo de Duplas</label>
            <input type="number" 
                   [(ngModel)]="novaPiramide.maxDuplas" 
                   name="maxDuplas"
                   min="10" 
                   max="100"
                   class="form-control">
            <small class="help-text">PadrÃ£o: 45 duplas (pirÃ¢mide 9 bases)</small>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Cor do Tema</label>
            <div class="cores-grid">
              <div class="cor-option" 
                   *ngFor="let cor of cores"
                   [style.background]="cor"
                   [class.selected]="novaPiramide.cor === cor"
                   (click)="novaPiramide.cor = cor">
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label>Ãcone</label>
            <div class="icones-grid">
              <div class="icone-option" 
                   *ngFor="let icone of icones"
                   [class.selected]="novaPiramide.icone === icone"
                   (click)="novaPiramide.icone = icone">
                {{ icone }}
              </div>
            </div>
          </div>
        </div>
        
        <div class="preview-piramide">
          <h4>Preview</h4>
          <div class="piramide-preview" [style.border-left-color]="novaPiramide.cor">
            <span class="preview-icone">{{ novaPiramide.icone }}</span>
            <div class="preview-info">
              <strong>{{ novaPiramide.nome || 'Nome da PirÃ¢mide' }}</strong>
              <span class="preview-categoria">{{ getCategoriaNome(novaPiramide.categoria) }}</span>
            </div>
          </div>
        </div>
        
        <div class="alert-message" *ngIf="mensagem" [class]="tipoMensagem">
          {{ mensagem }}
        </div>
        
        <div class="form-actions">
          <button type="button" 
                  class="btn-cancelar" 
                  (click)="fecharModalNova()"
                  [disabled]="loading">
            Cancelar
          </button>
          <button type="submit" 
                  class="btn-criar" 
                  [disabled]="loading || !novaForm.form.valid">
            <span *ngIf="loading">Criando...</span>
            <span *ngIf="!loading">â• Criar PirÃ¢mide</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal EdiÃ§Ã£o -->
<div class="modal-overlay" *ngIf="mostrarModalEdicao" (click)="fecharModalEdicao()">
  <div class="modal-content edicao-piramide" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>âœï¸ Editar PirÃ¢mide</h3>
      <button class="btn-close" (click)="fecharModalEdicao()">Ã—</button>
    </div>
    
    <div class="modal-body">
      <form (ngSubmit)="salvarEdicao()" #edicaoForm="ngForm">
        <div class="form-group">
          <label>Nome da PirÃ¢mide *</label>
          <input type="text" 
                 [(ngModel)]="piramideEdicao.nome" 
                 name="nome"
                 required
                 class="form-control">
        </div>
        
        <div class="form-group">
          <label>DescriÃ§Ã£o</label>
          <textarea [(ngModel)]="piramideEdicao.descricao" 
                    name="descricao"
                    class="form-control" 
                    rows="3"></textarea>
        </div>
        
        <div class="form-group">
          <label>Categoria</label>
          <select [(ngModel)]="piramideEdicao.categoria" 
                  name="categoria"
                  class="form-control">
            <option *ngFor="let cat of categorias" [value]="cat.value">
              {{ cat.label }}
            </option>
          </select>
        </div>
        
        <div class="alert-message" *ngIf="mensagem" [class]="tipoMensagem">
          {{ mensagem }}
        </div>
        
        <div class="form-actions">
          <button type="button" 
                  class="btn-cancelar" 
                  (click)="fecharModalEdicao()"
                  [disabled]="loading">
            Cancelar
          </button>
          <button type="submit" 
                  class="btn-salvar" 
                  [disabled]="loading || !edicaoForm.form.valid">
            <span *ngIf="loading">Salvando...</span>
            <span *ngIf="!loading">ğŸ’¾ Salvar</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal EstatÃ­sticas -->
<div class="modal-overlay" *ngIf="mostrarModalEstatisticas" (click)="fecharModalEstatisticas()">
  <div class="modal-content estatisticas-piramide" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>ğŸ“Š EstatÃ­sticas da PirÃ¢mide</h3>
      <button class="btn-close" (click)="fecharModalEstatisticas()">Ã—</button>
    </div>
    
    <div class="modal-body" *ngIf="estatisticasSelecionada">
      <div class="estatisticas-grid">
        <div class="stat-card">
          <div class="stat-icone">ğŸ‘¥</div>
          <div class="stat-info">
            <h4>{{ estatisticasSelecionada.totalDuplas }}</h4>
            <p>Duplas Ativas</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icone">ğŸ“‹</div>
          <div class="stat-info">
            <h4>{{ estatisticasSelecionada.vagasDisponiveis }}</h4>
            <p>Vagas DisponÃ­veis</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icone">âš”ï¸</div>
          <div class="stat-info">
            <h4>{{ estatisticasSelecionada.totalJogos }}</h4>
            <p>Total de Jogos</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icone">ğŸ“ˆ</div>
          <div class="stat-info">
            <h4>{{ estatisticasSelecionada.rotatividade }}%</h4>
            <p>Rotatividade</p>
          </div>
        </div>
      </div>
      
      <div class="detalhes-estatisticas">
        <h4>ğŸ“‹ Detalhes</h4>
        <ul>
          <li><strong>Tempo mÃ©dio por base:</strong> {{ estatisticasSelecionada.tempoMedioBase }} dias</li>
          <li><strong>Ãšltima atividade:</strong> {{ formatarData(estatisticasSelecionada.ultimaAtividade) }}</li>
          <li><strong>Status:</strong> Sistema funcionando normalmente</li>
        </ul>
      </div>
    </div>
  </div>
</div>