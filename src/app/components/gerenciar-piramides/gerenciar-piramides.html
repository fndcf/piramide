<!-- src/app/components/gerenciar-piramides/gerenciar-piramides.html - ATUALIZADO -->

<div class="modal-overlay" *ngIf="mostrar" (click)="fecharModal()">
  <div class="modal-content gerenciar-piramides" (click)="$event.stopPropagation()">
    <!-- âœ… HEADER CORRIGIDO: Com botÃ£o de refresh -->
    <div class="modal-header">
      <h3>ğŸ—ï¸ Gerenciar PirÃ¢mides</h3>
      <div class="header-actions">
        <button class="btn-refresh-modal" 
                (click)="forcarRefresh()" 
                [disabled]="loading"
                title="Atualizar lista de pirÃ¢mides">
          ğŸ”„
        </button>
        <button class="btn-close" (click)="fecharModal()">Ã—</button>
      </div>
    </div>
    
    <div class="modal-body">
      <!-- âœ… INDICADOR DE REFRESH -->
      <div class="refresh-indicator" *ngIf="loading">
        <div class="spinner-pequeno"></div>
        <span>Atualizando lista de pirÃ¢mides...</span>
      </div>

      <!-- Filtros e Controles -->
      <div class="controles-superiores">
        <div class="filtros">
          <div class="filtro-grupo">
            <label>Status:</label>
            <select [(ngModel)]="filtroStatus" class="filtro-select" (change)="aplicarFiltros()">
              <option value="todas">Todas</option>
              <option value="ativa">Ativas</option>
              <option value="pausada">Pausadas</option>
              <option value="finalizada">Finalizadas</option>
              <option value="arquivada">Arquivadas</option>
            </select>
          </div>
          
          <div class="filtro-grupo">
            <label>Categoria:</label>
            <select [(ngModel)]="filtroCategoria" class="filtro-select" (change)="aplicarFiltros()">
              <option value="todas">Todas</option>
              <option *ngFor="let cat of categorias" [value]="cat.value">{{ cat.label }}</option>
            </select>
          </div>
          
          <div class="filtro-grupo busca">
            <label>Buscar:</label>
            <input type="text" 
                   [(ngModel)]="termoBusca" 
                   (input)="aplicarFiltros()"
                   placeholder="Nome da pirÃ¢mide..."
                   class="filtro-input">
          </div>
        </div>
        
        <div class="acoes-principais">
          <button class="btn-nova-piramide" (click)="abrirModalNova()">
            â• Nova PirÃ¢mide
          </button>
        </div>
      </div>

      <!-- âœ… CONTADOR DE PIRÃ‚MIDES -->
      <div class="contador-piramides" *ngIf="!loading">
        <p>ğŸ“Š Total: {{ piramides.length }} pirÃ¢mide(s) | Exibindo: {{ piramidesFiltradas.length }}</p>
      </div>

      <!-- Lista de PirÃ¢mides -->
      <div class="piramides-lista" *ngIf="!loading">
        <div class="piramide-card" 
             *ngFor="let piramide of piramidesFiltradas; trackBy: trackByPiramideId"
             [class.atual]="isAtual(piramide)"
             [class.finalizada]="piramide.status === 'finalizada'"
             [class.pausada]="piramide.status === 'pausada'"
             [class.arquivada]="piramide.status === 'arquivada'"
             [style.border-left-color]="piramide.cor">
          
          <div class="piramide-header">
            <div class="piramide-info">
              <span class="piramide-icone">{{ piramide.icone }}</span>
              <div class="piramide-detalhes">
                <h4 class="piramide-nome">{{ piramide.nome }}</h4>
                <div class="piramide-meta">
                  <span class="categoria">{{ getCategoriaNome(piramide.categoria) }}</span>
                  <span class="separador">â€¢</span>
                  <span class="duplas-count">{{ piramide.totalDuplas }} duplas</span>
                  <span class="separador">â€¢</span>
                  <span class="ultima-atividade">{{ formatarData(piramide.ultimaAtividade) }}</span>
                </div>
              </div>
            </div>
            
            <div class="piramide-status">
              <span class="status-badge" [class]="getStatusBadgeClass(piramide.status)">
                {{ getStatusTexto(piramide.status) }}
              </span>
              <span class="atual-badge" *ngIf="isAtual(piramide)">ATUAL</span>
            </div>
          </div>
          
          <!-- âœ… AÃ‡Ã•ES ATUALIZADAS COM REFRESH AUTOMÃTICO -->
          <div class="piramide-acoes">
            <button class="btn-acao selecionar" 
                    (click)="selecionarPiramide(piramide)"
                    [disabled]="isAtual(piramide) || piramide.status === 'arquivada'"
                    title="Selecionar como pirÃ¢mide ativa">
              ğŸ¯ {{ isAtual(piramide) ? 'Selecionada' : 'Selecionar' }}
            </button>
            
            <button class="btn-acao estatisticas" 
                    (click)="abrirEstatisticas(piramide)"
                    title="Ver estatÃ­sticas">
              ğŸ“Š
            </button>
            
            <button class="btn-acao editar" 
                    (click)="abrirModalEdicao(piramide)"
                    [disabled]="!isPiramideEditavel(piramide)"
                    title="Editar pirÃ¢mide">
              âœï¸
            </button>
            
            <!-- âœ… BOTÃƒO DE REATIVAÃ‡ÃƒO (sÃ³ aparece para pausadas/finalizadas) -->
            <button *ngIf="podeReativar(piramide)" 
                    class="btn-acao reativar" 
                    (click)="reativarPiramide(piramide)"
                    title="Reativar pirÃ¢mide">
              ğŸ”„ Reativar
            </button>
            
            <div class="dropdown-acoes">
              <button class="btn-acao mais" title="Mais aÃ§Ãµes">â‹®</button>
              <div class="dropdown-menu">
                <button *ngIf="piramide.status === 'ativa'" 
                        (click)="alterarStatus(piramide, 'pausada')">
                  â¸ï¸ Pausar
                </button>
                <button *ngIf="piramide.status === 'pausada'" 
                        (click)="alterarStatus(piramide, 'ativa')">
                  â–¶ï¸ Reativar
                </button>
                <button *ngIf="piramide.status !== 'finalizada'" 
                        (click)="alterarStatus(piramide, 'finalizada')">
                  ğŸ Finalizar
                </button>
                <button *ngIf="piramide.status !== 'arquivada'" 
                        (click)="arquivarPiramide(piramide)"
                        class="acao-perigosa">
                  ğŸ“¦ Arquivar
                </button>
                
                <!-- âœ… NOVA OPÃ‡ÃƒO: Excluir (sÃ³ para finalizadas) -->
                <button *ngIf="podeExcluir(piramide)" 
                        (click)="confirmarExclusao(piramide)"
                        class="acao-muito-perigosa">
                  ğŸ—‘ï¸ Excluir Permanentemente
                </button>
              </div>
            </div>
          </div>

          <!-- âœ… AVISO PARA PIRÃ‚MIDES FINALIZADAS -->
          <div *ngIf="piramide.status === 'finalizada'" class="aviso-finalizada">
            âš ï¸ PirÃ¢mide finalizada: NÃ£o aceita duplas nem desafios. 
            <button class="link-button" (click)="reativarPiramide(piramide)">Reativar</button> ou 
            <button class="link-button acao-perigosa" (click)="confirmarExclusao(piramide)">Excluir</button>
          </div>

          <!-- âœ… AVISO PARA PIRÃ‚MIDES PAUSADAS -->
          <div *ngIf="piramide.status === 'pausada'" class="aviso-pausada">
            â¸ï¸ PirÃ¢mide pausada: OperaÃ§Ãµes suspensas temporariamente. 
            <button class="link-button" (click)="reativarPiramide(piramide)">Reativar</button>
          </div>
        </div>
        
        <!-- âœ… MENSAGEM MELHORADA quando nÃ£o hÃ¡ pirÃ¢mides -->
        <div class="sem-piramides" *ngIf="piramidesFiltradas.length === 0 && piramides.length === 0">
          <div class="icone">ğŸ—ï¸</div>
          <h4>Nenhuma pirÃ¢mide encontrada</h4>
          <p>Ainda nÃ£o hÃ¡ pirÃ¢mides criadas no sistema</p>
          <button class="btn-criar-primeira" (click)="abrirModalNova()">
            â• Criar Primeira PirÃ¢mide
          </button>
        </div>

        <!-- âœ… MENSAGEM quando filtro nÃ£o retorna resultados -->
        <div class="sem-piramides" *ngIf="piramidesFiltradas.length === 0 && piramides.length > 0">
          <div class="icone">ğŸ”</div>
          <h4>Nenhuma pirÃ¢mide encontrada</h4>
          <p>Nenhuma pirÃ¢mide corresponde aos filtros aplicados</p>
          <button class="btn-limpar-filtros" (click)="limparFiltros()">
            ğŸ—‘ï¸ Limpar Filtros
          </button>
        </div>
      </div>

      <!-- âœ… LOADING MELHORADO -->
      <div class="loading-container" *ngIf="loading">
        <div class="spinner"></div>
        <p>{{ loadingMessage || 'Carregando pirÃ¢mides...' }}</p>
      </div>

      <!-- Mensagem de feedback -->
      <div class="alert-message" *ngIf="mensagem" [class]="tipoMensagem">
        {{ mensagem }}
      </div>
    </div>
  </div>
</div>

<!-- âœ… MODAL DE CONFIRMAÃ‡ÃƒO DE EXCLUSÃƒO (mantido igual) -->
<div class="modal-overlay" *ngIf="mostrarModalConfirmacaoExclusao" (click)="fecharModalConfirmacaoExclusao()">
  <div class="modal-content confirmacao-exclusao" (click)="$event.stopPropagation()">
    <div class="modal-header perigo">
      <h3>ğŸ—‘ï¸ Excluir PirÃ¢mide</h3>
      <button class="btn-close" (click)="fecharModalConfirmacaoExclusao()">Ã—</button>
    </div>
    
    <div class="modal-body" *ngIf="piramideParaExcluir">
      <div class="aviso-perigo">
        <h4>âš ï¸ ATENÃ‡ÃƒO: Esta aÃ§Ã£o Ã© IRREVERSÃVEL!</h4>
        <p>VocÃª estÃ¡ prestes a excluir permanentemente a pirÃ¢mide:</p>
        
        <div class="piramide-a-excluir">
          <span class="icone">{{ piramideParaExcluir.icone }}</span>
          <div class="info">
            <strong>{{ piramideParaExcluir.nome }}</strong>
            <span>{{ getCategoriaNome(piramideParaExcluir.categoria) }} â€¢ {{ piramideParaExcluir.totalDuplas }} duplas</span>
          </div>
        </div>
        
        <div class="consequencias">
          <h5>ğŸ”¥ O que serÃ¡ perdido para sempre:</h5>
          <ul>
            <li>âœ— Todas as duplas desta pirÃ¢mide</li>
            <li>âœ— Todo o histÃ³rico de jogos e desafios</li>
            <li>âœ— Todas as estatÃ­sticas e rankings</li>
            <li>âœ— Todas as configuraÃ§Ãµes personalizadas</li>
            <li>âœ— Esta pirÃ¢mide nÃ£o poderÃ¡ ser recuperada</li>
          </ul>
        </div>
        
        <div class="alternativas">
          <h5>ğŸ’¡ Alternativas mais seguras:</h5>
          <ul>
            <li>ğŸ“¦ <strong>Arquivar:</strong> Mantem os dados, mas oculta a pirÃ¢mide</li>
            <li>â¸ï¸ <strong>Pausar:</strong> Suspende temporariamente as atividades</li>
          </ul>
        </div>
      </div>
      
      <div class="confirmacao-digitacao">
        <p><strong>Para confirmar, digite exatamente:</strong> <code>EXCLUIR {{ piramideParaExcluir.nome }}</code></p>
        <input type="text" 
               [(ngModel)]="textoConfirmacao"
               placeholder="Digite a confirmaÃ§Ã£o aqui..."
               class="input-confirmacao"
               [class.valida]="isConfirmacaoValida()"
               [class.invalida]="textoConfirmacao.length > 0 && !isConfirmacaoValida()"
               autocomplete="off">
        
        <!-- âœ… INDICADOR VISUAL -->
        <div class="status-confirmacao" *ngIf="textoConfirmacao.length > 0">
          <span *ngIf="isConfirmacaoValida()" class="status-ok">âœ… ConfirmaÃ§Ã£o correta</span>
          <span *ngIf="!isConfirmacaoValida()" class="status-erro">âŒ Digite exatamente como mostrado acima</span>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" 
                class="btn-cancelar" 
                (click)="fecharModalConfirmacaoExclusao()"
                [disabled]="loading">
          Cancelar (Recomendado)
        </button>
        <button type="button" 
                class="btn-excluir" 
                (click)="excluirPiramide()"
                [disabled]="loading || !isConfirmacaoValida()">
          <span *ngIf="loading">Excluindo...</span>
          <span *ngIf="!loading">ğŸ—‘ï¸ Excluir PERMANENTEMENTE</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Nova PirÃ¢mide (mantido igual) -->
<div class="modal-overlay" *ngIf="mostrarModalNova" (click)="fecharModalNova()">
  <div class="modal-content nova-piramide" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>â• Nova PirÃ¢mide</h3>
      <button class="btn-close" (click)="fecharModalNova()">Ã—</button>
    </div>
    
    <div class="modal-body">
      <form (ngSubmit)="criarPiramide()" #novaForm="ngForm">
        <div class="form-group">
          <label>Nome da PirÃ¢mide *</label>
          <input type="text" 
                 [(ngModel)]="novaPiramide.nome" 
                 name="nome"
                 placeholder="Ex: PirÃ¢mide Masculina 2025"
                 required
                 class="form-control">
        </div>
        
        <div class="form-group">
          <label>DescriÃ§Ã£o</label>
          <textarea [(ngModel)]="novaPiramide.descricao" 
                    name="descricao"
                    placeholder="DescriÃ§Ã£o opcional da pirÃ¢mide..."
                    class="form-control" 
                    rows="3"></textarea>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Categoria *</label>
            <select [(ngModel)]="novaPiramide.categoria" 
                    name="categoria"
                    required
                    class="form-control">
              <option *ngFor="let cat of categorias" [value]="cat.value">
                {{ cat.label }}
              </option>
            </select>
            <small class="help-text">
              {{ getCategoriaDescricao(novaPiramide.categoria) }}
            </small>
          </div>
          
          <div class="form-group">
            <label>MÃ¡ximo de Duplas</label>
            <input type="number" 
                   [(ngModel)]="novaPiramide.maxDuplas" 
                   name="maxDuplas"
                   min="10" 
                   max="100"
                   class="form-control">
            <small class="help-text">PadrÃ£o: 45 duplas (pirÃ¢mide 9 bases)</small>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Cor do Tema</label>
            <div class="cores-grid">
              <div class="cor-option" 
                   *ngFor="let cor of cores"
                   [style.background]="cor"
                   [class.selected]="novaPiramide.cor === cor"
                   (click)="novaPiramide.cor = cor">
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label>Ãcone</label>
            <div class="icones-grid">
              <div class="icone-option" 
                   *ngFor="let icone of icones"
                   [class.selected]="novaPiramide.icone === icone"
                   (click)="novaPiramide.icone = icone">
                {{ icone }}
              </div>
            </div>
          </div>
        </div>
        
        <div class="preview-piramide">
          <h4>Preview</h4>
          <div class="piramide-preview" [style.border-left-color]="novaPiramide.cor">
            <span class="preview-icone">{{ novaPiramide.icone }}</span>
            <div class="preview-info">
              <strong>{{ novaPiramide.nome || 'Nome da PirÃ¢mide' }}</strong>
              <span class="preview-categoria">{{ getCategoriaNome(novaPiramide.categoria) }}</span>
            </div>
          </div>
        </div>
        
        <div class="alert-message" *ngIf="mensagem" [class]="tipoMensagem">
          {{ mensagem }}
        </div>
        
        <div class="form-actions">
          <button type="button" 
                  class="btn-cancelar" 
                  (click)="fecharModalNova()"
                  [disabled]="loading">
            Cancelar
          </button>
          <button type="submit" 
                  class="btn-criar" 
                  [disabled]="loading || !novaForm.form.valid">
            <span *ngIf="loading">Criando...</span>
            <span *ngIf="!loading">â• Criar PirÃ¢mide</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal EdiÃ§Ã£o (mantido igual) -->
<div class="modal-overlay" *ngIf="mostrarModalEdicao" (click)="fecharModalEdicao()">
  <div class="modal-content edicao-piramide" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>âœï¸ Editar PirÃ¢mide</h3>
      <button class="btn-close" (click)="fecharModalEdicao()">Ã—</button>
    </div>
    
    <div class="modal-body">
      <form (ngSubmit)="salvarEdicao()" #edicaoForm="ngForm">
        <div class="form-group">
          <label>Nome da PirÃ¢mide *</label>
          <input type="text" 
                 [(ngModel)]="piramideEdicao.nome" 
                 name="nome"
                 required
                 class="form-control">
        </div>
        
        <div class="form-group">
          <label>DescriÃ§Ã£o</label>
          <textarea [(ngModel)]="piramideEdicao.descricao" 
                    name="descricao"
                    class="form-control" 
                    rows="3"></textarea>
        </div>
        
        <div class="form-group">
          <label>Categoria</label>
          <select [(ngModel)]="piramideEdicao.categoria" 
                  name="categoria"
                  class="form-control">
            <option *ngFor="let cat of categorias" [value]="cat.value">
              {{ cat.label }}
            </option>
          </select>
        </div>
        
        <div class="alert-message" *ngIf="mensagem" [class]="tipoMensagem">
          {{ mensagem }}
        </div>
        
        <div class="form-actions">
          <button type="button" 
                  class="btn-cancelar" 
                  (click)="fecharModalEdicao()"
                  [disabled]="loading">
            Cancelar
          </button>
          <button type="submit" 
                  class="btn-salvar" 
                  [disabled]="loading || !edicaoForm.form.valid">
            <span *ngIf="loading">Salvando...</span>
            <span *ngIf="!loading">ğŸ’¾ Salvar</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal EstatÃ­sticas (mantido igual) -->
<div class="modal-overlay" *ngIf="mostrarModalEstatisticas" (click)="fecharModalEstatisticas()">
  <div class="modal-content estatisticas-piramide" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>ğŸ“Š EstatÃ­sticas da PirÃ¢mide</h3>
      <button class="btn-close" (click)="fecharModalEstatisticas()">Ã—</button>
    </div>
    
    <div class="modal-body" *ngIf="estatisticasSelecionada">
      <div class="estatisticas-grid">
        <div class="stat-card">
          <div class="stat-icone">ğŸ‘¥</div>
          <div class="stat-info">
            <h4>{{ estatisticasSelecionada.totalDuplas }}</h4>
            <p>Duplas Ativas</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icone">ğŸ“‹</div>
          <div class="stat-info">
            <h4>{{ estatisticasSelecionada.vagasDisponiveis }}</h4>
            <p>Vagas DisponÃ­veis</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icone">âš”ï¸</div>
          <div class="stat-info">
            <h4>{{ estatisticasSelecionada.totalJogos }}</h4>
            <p>Total de Jogos</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icone">ğŸ“ˆ</div>
          <div class="stat-info">
            <h4>{{ estatisticasSelecionada.rotatividade }}%</h4>
            <p>Rotatividade</p>
          </div>
        </div>
      </div>
      
      <div class="detalhes-estatisticas">
        <h4>ğŸ“‹ Detalhes</h4>
        <ul>
          <li><strong>Tempo mÃ©dio por base:</strong> {{ estatisticasSelecionada.tempoMedioBase }} dias</li>
          <li><strong>Ãšltima atividade:</strong> {{ formatarData(estatisticasSelecionada.ultimaAtividade) }}</li>
          <li><strong>Status:</strong> Sistema funcionando normalmente</li>
        </ul>
      </div>
    </div>
  </div>
</div>