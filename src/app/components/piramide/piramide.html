<div class="piramide-container">
  <div class="header">
    <h2>ğŸ† PirÃ¢mide Beach Tennis</h2>
    <p class="subtitle">Sistema de classificaÃ§Ã£o por desafios</p>
    
    <!-- Controles de Acesso -->
    <div class="access-controls">
      <!-- Se nÃ£o estiver logado -->
      <div *ngIf="!authService.isLoggedIn()" class="login-section">
        <div class="login-buttons">
          <button class="btn-login-admin" (click)="mostrarModalLogin = true">
            ğŸ‘‘ Login Administrador
          </button>
          <button class="btn-login-jogador" (click)="mostrarModalJogador = true">
            ğŸ Login Jogador  
          </button>
        </div>
        <p class="access-info">Escolha seu tipo de acesso Ã  pirÃ¢mide</p>
      </div>
      
      <!-- Se estiver logado -->
      <div *ngIf="authService.isLoggedIn()" class="user-section">
        <div class="user-info">
          <span class="user-email">{{ getUserEmail() }}</span>
          <span *ngIf="isAdmin()" class="admin-badge">ğŸ‘‘ ADMIN</span>
          <span *ngIf="isJogador()" class="jogador-badge">ğŸ JOGADOR</span>
          <button (click)="logout()" class="btn-logout">Sair</button>
        </div>
        
        <!-- InformaÃ§Ãµes da dupla (apenas jogadores) -->
        <div *ngIf="isJogador() && jogadorInfo" class="jogador-info">
          <h4>ğŸ“Š Sua Dupla</h4>
          <p><strong>Jogadores:</strong> {{ jogadorInfo.dupla.jogador1 }} / {{ jogadorInfo.dupla.jogador2 }}</p>
          <p><strong>PosiÃ§Ã£o na PirÃ¢mide:</strong> {{ getPosicaoNaPiramide(jogadorInfo.dupla) }}Âº lugar</p>
          <p><strong>EstatÃ­sticas:</strong> {{ jogadorInfo.dupla.vitorias }} vitÃ³rias - {{ jogadorInfo.dupla.derrotas }} derrotas</p>
          
          <div class="desafios-info">
            <h5>ğŸ¯ Regras de Desafio</h5>
            <p><strong>VocÃª pode desafiar:</strong> {{ getQuantidadeDesafiosDisponiveis() }} dupla(s)</p>
            <p><small>â€¢ <strong>Mesma base ({{ jogadorInfo.dupla.base }}):</strong> duplas Ã  sua esquerda</small></p>
            <p><small>â€¢ <strong>Base acima ({{ jogadorInfo.dupla.base - 1 }}):</strong> duplas Ã  sua direita</small></p>
            <p><small>Sua dupla estÃ¡ em <span class="cor-dourada">dourado</span>, desafios disponÃ­veis em <span class="cor-verde">verde</span></small></p>
            
            <div class="regras-avancadas">
              <h6>âš”ï¸ Sistema de Risco/Recompensa</h6>
              <p><small>â€¢ <strong>VitÃ³ria:</strong> Assume a posiÃ§Ã£o do adversÃ¡rio</small></p>
              <p><small>â€¢ <strong>Derrota:</strong> Cai posiÃ§Ãµes = diferenÃ§a entre vocÃªs</small></p>
              <p><small>â€¢ <strong>Exemplo:</strong> 7Âº vs 5Âº â†’ Perde = cai para 9Âº (7-5=2)</small></p>
              <p><small>â€¢ <strong>Limite:</strong> Nunca cai alÃ©m do Ãºltimo lugar da pirÃ¢mide</small></p>
            </div>
          </div>
        </div>
        
        <!-- Controles de Admin -->
        <div class="admin-controls" *ngIf="isAdmin()">
          <button class="btn-admin" (click)="mostrarModalAdicionar = true">
            â• Adicionar Dupla
          </button>
          <button class="btn-admin btn-refresh" (click)="carregarDuplas()">
            ğŸ”„ Atualizar
          </button>
          <button class="btn-admin btn-config" (click)="mostrarModalConfig = true">
            âš™ï¸ ConfiguraÃ§Ãµes
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="piramide" *ngIf="!carregando">
    <div *ngFor="let base of basesReais; let i = index" 
         class="nivel" 
         [attr.data-nivel]="i + 1">
      
      <div class="duplas-linha">
        <!-- Duplas existentes -->
        <div *ngFor="let dupla of base; let j = index" 
             class="dupla-card preenchida"
             [class.selected]="dupla.selected"
             [class.minha-dupla]="isMinhaDupla(dupla)"
             [class.pode-desafiar]="isJogador() && podeDesafiar(dupla)"
             [class.desafio-disponivel]="isJogador() && podeDesafiar(dupla)"
             [class.admin-selectable]="isAdmin()"
             (click)="selecionarDupla(dupla)"
             [title]="getTituloCard(dupla)">
          <div class="jogadores">{{ dupla.jogador1 }} / {{ dupla.jogador2 }}</div>
          <div class="stats">{{ dupla.vitorias }}V-{{ dupla.derrotas }}D</div>
          <div class="posicao-geral">{{ getPosicaoNaPiramide(dupla) }}Âº</div>
          
          <!-- Indicador de "Minha Dupla" -->
          <div *ngIf="isMinhaDupla(dupla)" class="badge-minha">MEU</div>
          
          <!-- Indicador de desafio disponÃ­vel (apenas visual para jogadores) -->
          <div *ngIf="isJogador() && podeDesafiar(dupla)" class="badge-desafio-info">?</div>
          
          <!-- Indicador de seleÃ§Ã£o para admin -->
          <div *ngIf="isAdmin() && dupla.selected" class="badge-selecionada">âœ“</div>
          
          <!-- BotÃ£o de remover (apenas admin) -->
          <button *ngIf="isAdmin()" 
                  class="btn-remover" 
                  (click)="removerDupla($event, dupla)"
                  title="Remover dupla">
            Ã—
          </button>
        </div>
        
        <!-- Slots vazios -->
        <div *ngFor="let slot of getSlots(i + 1, base.length)" 
             class="dupla-card vazia"
             (click)="isAdmin() ? (mostrarModalAdicionar = true) : null"
             [class.clickable]="isAdmin()">
          <div class="jogadores">{{ isAdmin() ? '+ Adicionar' : 'Vaga' }}</div>
          <div class="stats">{{ isAdmin() ? 'Dupla' : 'DisponÃ­vel' }}</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Loading -->
  <div class="loading" *ngIf="carregando">
    <div class="spinner"></div>
    <p>Carregando pirÃ¢mide...</p>
  </div>
  
  
  <!-- Controles de seleÃ§Ã£o - APENAS PARA ADMINISTRADORES -->
  <div class="controles admin-only" *ngIf="duplasSelecionadas.length > 0 && isAdmin()">
    <div class="admin-section-header">
      <h3>ğŸ‘‘ Ãrea Administrativa - CriaÃ§Ã£o de Desafios</h3>
      <p>Como administrador, vocÃª pode criar desafios entre qualquer dupla respeitando as regras da pirÃ¢mide.</p>
    </div>
    
    <p class="selection-info">{{ duplasSelecionadas.length }} dupla(s) selecionada(s)</p>
    
    <!-- âœ… PREVIEW DO DESAFIO: Apenas para admins -->
    <div *ngIf="duplasSelecionadas.length === 2" class="preview-desafio">
      <h4>ğŸ¥Š Preview do Desafio</h4>
      <div class="duplas-preview">
        <div class="dupla-preview">
          <strong>{{ getDuplaDesafiante().jogador1 }}/{{ getDuplaDesafiante().jogador2 }}</strong>
          <span class="posicao">{{ getPosicaoNaPiramide(getDuplaDesafiante()) }}Âº lugar</span>
          <span class="role desafiante">DESAFIANTE</span>
        </div>
        <div class="vs">VS</div>
        <div class="dupla-preview">
          <strong>{{ getDuplaDesafiado().jogador1 }}/{{ getDuplaDesafiado().jogador2 }}</strong>
          <span class="posicao">{{ getPosicaoNaPiramide(getDuplaDesafiado()) }}Âº lugar</span>
          <span class="role desafiado">DESAFIADO</span>
        </div>
      </div>
      <div class="info-desafio">
        <p><small>ğŸ’¡ DiferenÃ§a: {{ Math.abs(getPosicaoNaPiramide(getDuplaDesafiante()) - getPosicaoNaPiramide(getDuplaDesafiado())) }} posiÃ§Ãµes</small></p>
      </div>
    </div>
    
    <div class="botoes-controle">
      <button (click)="criarDesafio()" 
              [disabled]="duplasSelecionadas.length !== 2"
              class="btn-desafio admin-btn">
        {{ duplasSelecionadas.length === 2 ? 'âš”ï¸ Registrar Resultado do Desafio' : 'Selecione 2 duplas para criar desafio' }}
      </button>
      <button (click)="limparSelecao()" class="btn-limpar admin-btn">ğŸ—‘ï¸ Limpar SeleÃ§Ã£o</button>
    </div>
  </div>
  
  <div class="info-cards">
    <div class="info-card">
      <h4>ğŸ“Š EstatÃ­sticas</h4>
      <p>Total de duplas: {{ getTotalDuplas() }}</p>
      <p>Vagas disponÃ­veis: {{ getTotalVagas() }}</p>
      <p>Status: {{ getStatusUsuario() }}</p>
    </div>
    
    <div class="info-card">
      <h4>ğŸ¯ Regras de Desafio</h4>
      <p>â€¢ <strong>Mesma base:</strong> Pode desafiar duplas Ã  sua esquerda</p>
      <p>â€¢ <strong>Base acima:</strong> Pode desafiar duplas Ã  sua direita</p>
      <p>â€¢ <strong>ğŸ† VitÃ³ria:</strong> Assume a posiÃ§Ã£o do adversÃ¡rio</p>
      <p>â€¢ <strong>ğŸ’¥ Derrota:</strong> Cai X posiÃ§Ãµes (X = diferenÃ§a entre vocÃªs)</p>
      <p>â€¢ <strong>ğŸ›¡ï¸ ProteÃ§Ã£o:</strong> Nunca cai alÃ©m do Ãºltimo lugar da pirÃ¢mide</p>
      <p>â€¢ <strong>âš¡ MovimentaÃ§Ã£o:</strong> Demais duplas ajustam automaticamente</p>
      <p *ngIf="isAdmin()" class="admin-info">â€¢ <strong>ğŸ‘‘ ADMIN:</strong> VocÃª pode criar desafios entre qualquer dupla vÃ¡lida</p>
      <p *ngIf="isJogador()" class="jogador-info">â€¢ <strong>ğŸ JOGADOR:</strong> VocÃª pode ver quais duplas poderia desafiar (destacadas em verde)</p>
      <p *ngIf="!authService.isLoggedIn()" class="visitante-info">â€¢ <strong>ğŸ‘€ VISITANTE:</strong> FaÃ§a login para participar ou administrar</p>
    </div>
  </div>
</div>

<!-- Modal de Resultado do Desafio -->
<div class="modal-overlay" *ngIf="mostrarModalResultado" (click)="fecharModalResultado()">
  <div class="modal-content resultado-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>âš”ï¸ Registrar Resultado do Desafio</h3>
      <button class="btn-close" (click)="fecharModalResultado()">Ã—</button>
    </div>
    
    <div class="modal-body" *ngIf="desafioAtual">
      <div class="desafio-info">
        <h4>ğŸ¥Š Confronto</h4>
        <div class="confronto">
          <div class="dupla desafiante">
            <div class="dupla-nome">{{ desafioAtual.desafiante.jogador1 }} / {{ desafioAtual.desafiante.jogador2 }}</div>
            <div class="dupla-posicao">{{ desafioAtual.posicaoDesafiante }}Âº lugar</div>
            <div class="dupla-role">DESAFIANTE</div>
          </div>
          
          <div class="vs-separator">
            <span>VS</span>
          </div>
          
          <div class="dupla desafiado">
            <div class="dupla-nome">{{ desafioAtual.desafiado.jogador1 }} / {{ desafioAtual.desafiado.jogador2 }}</div>
            <div class="dupla-posicao">{{ desafioAtual.posicaoDesafiado }}Âº lugar</div>
            <div class="dupla-role">DESAFIADO</div>
          </div>
        </div>
      </div>
      
      <div class="cenarios-resultado">
        <h4>ğŸ“ˆ CenÃ¡rios PossÃ­veis</h4>
        
        <div class="cenario vitoria">
          <div class="cenario-header">
            <h5>ğŸ† Se {{ desafioAtual.desafiante.jogador1 }}/{{ desafioAtual.desafiante.jogador2 }} VENCER</h5>
          </div>
          <div class="cenario-detalhes">
            <p>â€¢ <strong>Assume a {{ desafioAtual.posicaoDesafiado }}Âª posiÃ§Ã£o</strong></p>
            <p>â€¢ {{ desafioAtual.desafiado.jogador1 }}/{{ desafioAtual.desafiado.jogador2 }} desce para {{ desafioAtual.posicaoDesafiado + 1 }}Âª</p>
            <p>â€¢ Duplas entre as posiÃ§Ãµes {{ desafioAtual.posicaoDesafiado }} e {{ desafioAtual.posicaoDesafiante }} descem 1 posiÃ§Ã£o</p>
          </div>
        </div>
        
        <div class="cenario derrota">
          <div class="cenario-header">
            <h5>ğŸ’¥ Se {{ desafioAtual.desafiante.jogador1 }}/{{ desafioAtual.desafiante.jogador2 }} PERDER</h5>
          </div>
          <div class="cenario-detalhes">
            <ng-container *ngIf="(desafioAtual.posicaoDesafiante + desafioAtual.diferenciaPosicoes) <= getTotalDuplas(); else limitePiramide">
              <p>â€¢ <strong>Cai para a {{ desafioAtual.posicaoDesafiante + desafioAtual.diferenciaPosicoes }}Âª posiÃ§Ã£o</strong></p>
              <p>â€¢ Penalidade: {{ desafioAtual.diferenciaPosicoes }} posiÃ§Ãµes (diferenÃ§a do desafio)</p>
            </ng-container>
            <ng-template #limitePiramide>
              <p>â€¢ <strong>Cai para o Ãºltimo lugar ({{ getTotalDuplas() }}Âª posiÃ§Ã£o)</strong></p>
              <p>â€¢ âš ï¸ Penalidade limitada pelo tamanho da pirÃ¢mide</p>
              <p>â€¢ Penalidade original seria: {{ desafioAtual.diferenciaPosicoes }} posiÃ§Ãµes</p>
              <p>â€¢ Aplicada: {{ getTotalDuplas() - desafioAtual.posicaoDesafiante }} posiÃ§Ãµes</p>
            </ng-template>
            <p>â€¢ Duplas entre as posiÃ§Ãµes afetadas sobem 1 posiÃ§Ã£o</p>
          </div>
        </div>
      </div>
      
      <div class="resultado-buttons">
        <h4>ğŸ Qual foi o resultado?</h4>
        <div class="buttons-grid">
          <button class="btn-vitoria" (click)="aplicarResultadoDesafio(true)">
            ğŸ† {{ desafioAtual.desafiante.jogador1 }}/{{ desafioAtual.desafiante.jogador2 }} VENCEU
          </button>
          <button class="btn-derrota" (click)="aplicarResultadoDesafio(false)">
            ğŸ’¥ {{ desafioAtual.desafiado.jogador1 }}/{{ desafioAtual.desafiado.jogador2 }} VENCEU
          </button>
        </div>
      </div>
      
      <div class="aviso-importante">
        <h5>âš ï¸ Importante</h5>
        <p>Esta aÃ§Ã£o <strong>nÃ£o pode ser desfeita</strong>. As posiÃ§Ãµes na pirÃ¢mide serÃ£o atualizadas automaticamente conforme as regras estabelecidas.</p>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Login Administrador -->
<app-login-modal 
  [mostrar]="mostrarModalLogin"
  (fechar)="mostrarModalLogin = false"
  (loginSucesso)="onLoginSucesso()">
</app-login-modal>

<!-- Modal de Login Jogador -->
<app-login-jogador-modal 
  [mostrar]="mostrarModalJogador"
  (fechar)="mostrarModalJogador = false"
  (jogadorLogado)="onJogadorLogado($event)">
</app-login-jogador-modal>

<!-- Modal de ConfiguraÃ§Ã£o -->
<app-configuracao-modal 
  [mostrar]="mostrarModalConfig"
  (fechar)="mostrarModalConfig = false"
  (configuracaoAtualizada)="onConfiguracaoAtualizada()">
</app-configuracao-modal>

<!-- Modal para adicionar dupla -->
<app-adicionar-dupla 
  [mostrar]="mostrarModalAdicionar"
  (fechar)="mostrarModalAdicionar = false"
  (duplaAdicionada)="onDuplaAdicionada()">
</app-adicionar-dupla>